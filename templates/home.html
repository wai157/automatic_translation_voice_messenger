{% extends 'base.html' %} 
{% block main %}
<div class="flex w-full h-full divide-x divide-accent">
    <div class="flex flex-1 basis-1/3 justify-center items-center">
        <div class="flex flex-col w-4/5 h-[80vh] justify-start items-center bg-background rounded-xl border border-text overflow-y-auto">
            <div id="search-box" class="flex flex-col justify-center items-center w-full h-36 p-4 gap-4">
                <input type="text" id="user-to-chat" placeholder="Who you wanna chat with?" class="w-11/12 h-12 border-2 border-text rounded-xl p-2">
                <button class="w-12 h-12 border-2 border-text rounded-xl hover:bg-secondary flex justify-center items-center" onclick="find_room($('#user-to-chat').val())">
                    <svg xmlns="http://www.w3.org/2000/svg" height="2rem" width="2rem" viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M438.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L338.8 224 32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l306.7 0L233.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160z"/></svg>
                </button>
            </div>
            <table id="rooms" class="w-full border-y-[0.5px] border-text border-collapse">

            </table>
        </div>
    </div>
    <div class="flex flex-1 basis-2/3 justify-center items-center">
        <div class="flex flex-col w-11/12 h-[80vh] gap-2">
        <div id="chat-box" class="basis-4/5 h-80 grow p-4 border-2 overflow-y-auto overflow-x-hidden rounded-xl flex flex-col-reverse items-end gap-4">
        </div>
        <div class="basis-1/5 flex flex-row justify-between items-center gap-4">
            <div class="flex flex-col justify-center items-center h-full flex-1 bg-background py-8 px-16 rounded-xl border-2 gap-6 rounded-xl">
            <p>Current Mode</p>
            <select id="mode" class="w-4/5 h-12 bg-text text-center bg-white text-text rounded-xl border-2">
                <option value="vi-en">VI to EN</option>
                <option value="en-vi">EN to VI</option>
            </select>
            </div>
            <div class="flex justify-center items-center h-full flex-1">
            <button id="mic-btn" class="w-20 h-20 border-2 rounded-full hover:bg-slate-200 flex justify-center items-center">
                <svg xmlns="http://www.w3.org/2000/svg" height="32" width="24" viewBox="0 0 384 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h72 72c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/></svg>
            </button>
            </div>
        </div>
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='js/recorder.js') }}"></script>
<script src="{{ url_for('static', filename='js/socketio.js') }}"></script>
<script>
    var socket = io();
    var $chat_box = $("#chat-box");
    var room_id = "{{ current_user.username }}" + "-" + "{{ current_user.username }}"
    socket.on('message', function(data) {
        create_message(data.message);
        load_rooms(data.room_id, data.room_name);
    });
    socket.on('disconnect', function() {
        window.location.href = "{{ url_for('authentication.login') }}";
    });
    socket.on("new_msg", function(data) {
        if (data.room_id == room_id) {
            return;
        }
        $("#rooms").prepend(
            "<tr id='"+data.room_id+"' class=\"\"><td class=\"w-full h-16 animate-pulse border-y-[0.5px] border-text flex justify-between items-center p-8 text-text hover:bg-secondary cursor-pointer\" onclick=\"find_room('"+data.room_name+"')\">"
            +"<div class=\"h-fit w-fit\">"+data.room_name+"</div>"
            +"<div class=\"h-fit w-fit text-slate-500 text-sm\">"+data.last_message_timestamp+"</div>"
            +"</td></tr>"
        )
    });
    socket.on("error", function (){
        toastr.error("An error occurred!");
    })
</script>
<script>
    function load_rooms(temp_room_id, temp_room_name) {
        $.ajax({
            url: "{{ url_for('room.get_rooms') }}",
            method: "GET",
            success: function(data) {
                $("#rooms").empty();
                for (var i=0; i<data.length; i++) {
                    if (data[i].room_id == room_id) {
                        $("#rooms").append(
                            "<tr id='"+data[i].room_id+"' class=\"\"><td class=\"w-full h-16 border-y-[0.5px] border-text flex justify-between items-center p-8 text-text bg-slate-200 hover:bg-secondary cursor-pointer\" onclick=\"find_room('"+data[i].room_name+"')\">"
                            +"<div class=\"h-fit w-fit\">"+data[i].room_name+"</div>"
                            +"<div class=\"h-fit w-fit text-slate-500 text-sm\">"+data[i].last_message_timestamp+"</div>"
                            +"</td></tr>"
                        )
                        continue;
                    }
                    $("#rooms").append(
                        "<tr id='"+data[i].room_id+"' class=\"\"><td class=\"w-full h-16 border-y-[0.5px] border-text flex justify-between items-center p-8 text-text hover:bg-secondary cursor-pointer\" onclick=\"find_room('"+data[i].room_name+"')\">"
                        +"<div class=\"h-fit w-fit\">"+data[i].room_name+"</div>"
                        +"<div class=\"h-fit w-fit text-slate-500 text-sm\">"+data[i].last_message_timestamp+"</div>"
                        +"</td></tr>"
                    )
                }
                if (temp_room_id && document.getElementById(temp_room_id) == null) {
                    $("#rooms").prepend(
                        "<tr id='"+temp_room_id+"' class=\"\"><td class=\"w-full h-16 border-y-[0.5px] border-text flex justify-between items-center p-8 text-text bg-slate-200 hover:bg-secondary cursor-pointer\" onclick=\"find_room('"+temp_room_name+"')\">"
                        +"<div class=\"h-fit w-fit\">"+temp_room_name+"</div>"
                        +"<div class=\"h-fit w-fit text-slate-500 text-sm\"></div>"
                        +"</td></tr>"
                    )
                }
            },
            error: function(error) {
                toastr.error("Error loading rooms.");
            }
        });
    }
    function find_room(user_to_find) {
        $.ajax({
            url: "{{ url_for('room.find_room') }}",
            method: "GET",
            data: $.param({
                user_to_find: user_to_find,
            }),
            success: function(data) {
                socket.emit("leave", {
                    room: room_id,
                });
                room_id=data.room_id;
                socket.emit("join", {
                    room: room_id,
                });
                load_rooms(data.room_id, data.room_name);
                populate_chat(data.messages);
            },
            error: function(xhr, ajaxOptions, thrownError) {
                toastr.error(xhr.responseText);
            }
        })
    }
</script>
<script>
    function create_message(message) {
        $message = $("<div>", {
            "class": "w-1/2 h-fit shrink-0 p-2 flex flex-col justify-center items-start rounded-2xl border gap-2"
        });
        if (message.sender == "{{ current_user.username }}") {
            $message.addClass("bg-sky-300 self-end");
        } else {
            $message.addClass("bg-slate-200 self-start");
        }
        var original_voice_url = URL.createObjectURL(new Blob([new Uint8Array(message.original_voice)], {type: 'audio/wav'}));
        $original_voice = $("<audio>", {
            "class": "w-full h-10 shrink-0 grow-0",
            "src": original_voice_url,
            "controls": "",
        }).appendTo($message);
        $original_text = $("<p>", {
            "class": "w-full h-fit text-text text-wrap text-left pl-2"
        }).html(message.original_text).appendTo($message);
        var translated_voice_url = URL.createObjectURL(new Blob([new Uint8Array(message.translated_voice)], {type: 'audio/wav'}));
        $translated_voice = $("<audio>", {
            "class": "w-full h-10 shrink-0 grow-0",
            "src": translated_voice_url,
            "controls": "",
        }).appendTo($message);
        $translated_text = $("<p>", {
            "class": "w-full h-fit text-text text-wrap text-left pl-2"
        }).html(message.translated_text).appendTo($message);
        $timestamp = $("<div>", {
            "class": "h-fit w-fit text-slate-500 text-sm pl-2"
        }).html(message.timestamp).appendTo($message);
        $chat_box.prepend($message);
    }
    function populate_chat(messages) {
        $chat_box.empty();
        for (var i=0; i<messages.length; i++) {
            create_message(messages[i]);
        }
    }
</script>
<script>
    find_room("{{ current_user.username }}");
</script>
{% endblock %}
